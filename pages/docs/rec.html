<body>
<div id="docs_rec_PageContainer" style="width:100%;height:100%;">
    <div id="docs_rec_ListContainer" style="width:310px;height:100%; margin:0;padding:0;"></div>
    <div id="docs_rec_DetailContainer" style="width:100%;height:100%; margin:0;padding:0;">
        <div id="docs_rec_DetailHeader" style="width:100%;height:auto; margin:0;padding:0;"></div>
        <div id="docs_rec_ProductsTable" style="width:100%;height:100%; margin:0;padding:0;"></div>
        <div id="docs_rec_DetailTotal" style="width:100%;height:auto;; margin:0;padding:0;"></div>
    </div>
    <div id="docs_rec_RightContainer" style="width:250px;height:100%; margin:0;padding:0;"></div>
</div>
</body>
<script type="text/javascript">
    require(["app/app","app/tDocStdTable","dojo/request/iframe", /*"dojox/form/FileInput ",*/ "dojo/request/handlers", "app/request"],
            function (APP, TDocStdTable, iframe/*,FileInput*/,handlers, Request) {
                var wrh_pinv= APP.instanceForID("docs_rec_PageContainer", TDocStdTable,
                            { idListContainer:"docs_rec_ListContainer",idDetailContainer:"docs_rec_DetailContainer",
                                idDetailHeader:"docs_rec_DetailHeader",idDetailTable:"docs_rec_ProductsTable",idDetailTotal:"docs_rec_DetailTotal",
                                idRightContainer:"docs_rec_RightContainer" })
                        .addListTable({getDataUrl:"/docs/rec/getDataForRecsListTable",
                            header:"Список накладных", bdatelabelText:"c",bdateCondition:"DOCDATE>=", edatelabelText:"по",edateCondition:"DOCDATE<="
                        })
                        .setDetailHeaderParameters({dataIDName:"ChID",
                            getDataUrl:"/docs/rec/getRecData", getDataForNewUrl:"/docs/rec/getNewRecData",
                            postDataUrl:"/docs/rec/storeRecData", postForDeleteDataUrl:"/docs/rec/deleteRecData",
                            dataStateName:"StateCode", activeStateValue:0
                        })
                        .addDetailHeaderTitle({title:"Приход товара",
                            titleForNew:"Новая приходная накладная", titleForNothing:"Приход товара не выбран", titleForFailedLoad:"Нет данных",
                            numberDataItemName:"DocID", dateDataItemName:"DocDate", titleDatePrefix:"от"},25)
                        .addDetailHeaderRow(25,true)
                        .addDetailHeaderSelect("OurName","Фирма", 330,
                            {inputStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirOursForSelect", labelDataItem:"OurName"})
                        .addDetailHeaderTextBox("DocID", "Номер", 120, {inputStyle:"width:50px"})
                        .addDetailHeaderTextBox("IntDocID", "Вн. номер", 120, {inputStyle:"width:50px"})
                        .addDetailHeaderDateTextBox("DocDate", "Дата", 150, "width:80px")
                        .addDetailHeaderRow(25,true)
                        .addDetailHeaderSelect("StockName","Склад", 250,
                            {inputStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirStocksForSelect", labelDataItem:"StockName"})
                        .addDetailHeaderSelect("CompName","Предприятие", 280,
                            {inputStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirCompsForSelect", labelDataItem:"CompName"})
                        .addDetailHeaderSelect("CurrName","Валюта", 260,
                            {inputStyle:"width:200px", loadDropDownURL:"/dirsDocs/getDirCurrsForSelect", labelDataItem:"CurrName"})
                        .addDetailHeaderNumberTextBox("KursCC", "Курс валюты", 200, {inputStyle:"width:40px", pattern:"########0.00"})
                        .setDetailTableParameters({conditionIDName:"ParentChID",
                            getDataUrl:"/docs/rec/getDataForRecDTable",
                            storeDataUrl:"/docs/rec/storeRecDTableData", deleteDataUrl:"/docs/rec/deleteRecDTableData"})
                        .addDetailTotalRow()
                        .addDetailSubTotalCountNumberTextBox("ИТОГО СТРОК:", 190, {inputStyle:"width:40px;"})
                        .addDetailSubtotalNumberTextBox("ИТОГО КОЛИЧЕСТВО:", 700, "Qty", {pattern:"###,###,##0.#########", inputStyle:"width:50px;"})
                        .addDetailSubtotalNumberTextBox("ИТОГО СУММА:", 245, "SumCC_wt", {pattern:"###,###,##0.00#######", inputStyle:"width:80px;"})
                        .addDetailTotalRow(true)
                        .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ КОЛИЧЕСТВО:", 890, "TQty",
                            {pattern:"###,###,##0.#########", inputStyle:"width:50px;", style:"font-weight:bold;", printLabel:"ИТОГО КОЛИЧЕСТВО:"})
                        .addDetailTotalNumberTextBox("В ДОКУМЕНТЕ СУММА:", 245, "TSumCC_wt",
                            {pattern:"###,###,##0.00#######", inputStyle:"width:80px;", style:"font-weight:bold;", printLabel:"ИТОГО СУММА:"})
                        .addDetailTotalRow(true)
                        .addDetailTotalTextBox("Статус:", 1140, "StateName", {style:"font-weight:bold;", inputStyle:"width:200px", print:false})
                        .addToolPane({title:"Действия"})
                        .addToolPaneActionButton("Новая накладная", {btnStyle:"width:200px;", actionButtonName:"loadHeaderNewValues"})
                        .addToolPaneActionButton("Сохранить накладную", {btnStyle:"width:200px;", actionButtonName:"storeHeaderValues"})
                        .addToolPaneActionButton("Отменить изменения", {btnStyle:"width:200px;", actionButtonName:"loadHeaderLastValues"})
                        .addToolPaneActionButton("Удалить накладную", {btnStyle:"width:200px;", actionButtonName:"deleteHeader"})
                        .addToolPaneBR()
                        .addToolPaneActionButton("Добавить строку", {btnStyle:"width:200px;", actionButtonName:"insertDetailTableRow"})
                        .addToolPaneActionButton("Копировать строку", {btnStyle:"width:200px;", actionButtonName:"insertDetailTableCopySelectedRow"})
                        .addToolPaneActionButton("Изменить строку", {btnStyle:"width:200px;", actionButtonName:"allowEditDetailTableSelectedRow"})
                        .addToolPaneActionButton("Сохранить строку", {btnStyle:"width:200px;", actionButtonName:"storeDetailTableSelectedRow"})
                        .addToolPaneActionButton("Удалить строку", {btnStyle:"width:200px;", actionButtonName:"deleteDetailTableSelectedRow"})
//                        .addToolPane({title:"Статус документа"})
//                        .addToolPaneActionButton("Установить статус \"Закрыт\"", { btnStyle:"width:200px;",
//                            actionFunction: function (params) {
//                                var pinvId =  params.thisInstance.detailHeader.data.ID;    console.log("pinvId=",pinvId);
//                                Request.postJSONData({url: "/wrh/pInvoices/closePInv", data: {"PINV_ID": pinvId}},
//                                    function(result){
//                                        params.thisInstance.setDetailHeaderContentByListSelectedRow(wrh_pinv.detailHeader.lastContentData, {reloadData:true, clearBeforeLoad:true});
//                                });
//                            }
//                        })
//                        .addToolPaneActionButton("Установить статус \"В работе\"", {btnStyle:"width:200px;"})
                        .addDetailTableMenuItemAction("Добавить строки",{action:"insertDetailTableRowsAfterSelected",rowPosName:"POS"})//rowPosIndexName:"POSIND"
                        .addDetailTableMenuItemAction("Изменить строки",{action:"allowEditDetailTableSelectedRows"})
                        .addDetailTableMenuItemAction("Сохранить строки",{action:"storeDetailTableSelectedRows"})
                        .addDetailTableRowChangeCallback(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback) {
                            if(!thisInstance.setDetailTableProdData)
                                thisInstance.setDetailTableProdData= function(crd/*changedRowData*/,prodData){
                                    if(!prodData)prodData={};
                                    crd.item("ProdID").setValue(prodData["ProdID"]);
                                    crd.item("ProdName").setValue(prodData["ProdName"]);
                                    crd.item("UM").setValue(prodData["UM"]);
                                    crd.item("Barcode").setValue(prodData["Barcode"]);
                                };
                            if(!thisInstance.setDetailTableProdArticle1Attrs)
                                thisInstance.setDetailTableProdArticle1Attrs= function(crd/*changedRowData*/,prodData){
                                    if(!prodData)prodData={};
                                    crd.item("PCatName").setValue(prodData["PCatName"]);
                                    crd.item("PGrName").setValue(prodData["PGrName"]);
                                    crd.item("PGrName1").setValue(prodData["PGrName1"]);
                                    crd.item("PGrName2").setValue(prodData["PGrName2"]);
                                    crd.item("PGrName3").setValue(prodData["PGrName3"]);
                                };
                            if(!thisInstance.setDetailTableProdAttrs)
                                thisInstance.setDetailTableProdAttrs= function(crd/*changedRowData*/,prodData){
                                    if(!prodData)prodData={};
                                    crd.item("Article1").setValue(prodData["Article1"]);
                                    this.setDetailTableProdArticle1Attrs(crd,prodData);
                                    crd.item("ColorName").setValue(prodData["ColorName"]);
                                    crd.item("SizeName").setValue(prodData["SizeName"]);
                                };
                            nextCallback();
                        })
                        .addDetailTableRowChangeCallback(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback) {
                            var isChangedProdAttrs=crd.item("Article1").isChanged()
                                    ||crd.item("PCatName").isChanged()||crd.item("PGrName").isChanged()
                                    ||crd.item("PGrName1").isChanged()||crd.item("PGrName2").isChanged()||crd.item("PGrName3").isChanged()
                                    ||crd.item("ColorName").isChanged()||crd.item("SizeName").isChanged();
                            if (isChangedProdAttrs){
                                var condition={};
                                condition["Article1"]=crd.item("Article1").getValue();
                                condition["PCatName"]=crd.item("PCatName").getValue();
                                condition["PGrName"]=crd.item("PGrName").getValue();
                                condition["PGrName1"]=crd.item("PGrName1").getValue();
                                condition["PGrName2"]=crd.item("PGrName2").getValue();
                                condition["PGrName3"]=crd.item("PGrName3").getValue();
                                condition["ColorName"]=crd.item("ColorName").getValue();
                                condition["SizeName"]=crd.item("SizeName").getValue();
                                Request.getJSONData({url:"/dirsProds/getProdProdAttrsAndNameByArticle1", condition:condition},
                                        function(result){
                                            if (result.item) thisInstance.setDetailTableProdArticle1Attrs(crd,result.item);
                                            else if(result.error) thisInstance.setDetailTableProdArticle1Attrs(crd);
                                            if (result.itemProdName) thisInstance.setDetailTableProdData(crd,result.itemProdName);
                                            else thisInstance.setDetailTableProdData(crd);
                                            nextCallback(true);
                                        });
                                return;
//                            } else if (crd.item("ProdArticle1").isChanged()&&crd.item("ProdArticle1").isEMPTY()){
//                                var condition={};
//                                condition["ProdArticle1"]=crd.item("ProdArticle1").getValue();
//                                condition["PCatName"]=crd.item("PCatName").getValue();
//                                condition["PGrName"]=crd.item("PGrName").getValue();
//                                condition["PGrName1"]=crd.item("PGrName1").getValue();
//                                condition["PGrName2"]=crd.item("PGrName2").getValue();
//                                condition["PGrName3"]=crd.item("PGrName3").getValue();
//                                condition["ProdColor"]=crd.item("ProdColor").getValue();
//                                condition["ProdSize"]=crd.item("ProdSize").getValue();
//                                Request.getJSONData({url:"/dirsProds/getProdNameByAttrs", condition:condition},
//                                        function(result){
//                                            if (!result || !result.item) {
//                                                thisInstance.setDetailTableProdData(crd);
//                                                nextCallback(true);
//                                                return;
//                                            }
//                                            thisInstance.setDetailTableProdData(crd,result.item);
//                                            nextCallback(true);
//                                        });
//                                return;
                            }
                            nextCallback();
                        })
//                        .addDetailTableRowChangeCallback(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback) {
//                            if ((crd.item("PCatName").isChanged()||crd.item("PGrName").isChanged()
//                                    ||crd.item("PGrName1").isChanged()||crd.item("PGrName2").isChanged()||crd.item("PGrName3").isChanged()
//                                    ||crd.item("ProdColor").isChanged()||crd.item("ProdSize").isChanged())
//                                            && !crd.item("ProdID").isChanged() && !crd.item("ProdName").isChanged()){
//                                var condition={};
//                                condition["ProdArticle1"]=crd.item("ProdArticle1").getValue();
//                                condition["PCatName"]=crd.item("PCatName").getValue();
//                                condition["PGrName"]=crd.item("PGrName").getValue();
//                                condition["PGrName1"]=crd.item("PGrName1").getValue();
//                                condition["PGrName2"]=crd.item("PGrName2").getValue();
//                                condition["PGrName3"]=crd.item("PGrName3").getValue();
//                                condition["ProdColor"]=crd.item("ProdColor").getValue();
//                                condition["ProdSize"]=crd.item("ProdSize").getValue();
//                                Request.getJSONData({url:"/dirsProds/getProdNameByAttrs", condition:condition},
//                                        function(result){
//                                            if (!result || !result.item) {
//                                                thisInstance.setDetailTableProdData(crd);
//                                                nextCallback(true);
//                                                return;
//                                            }
//                                            thisInstance.setDetailTableProdData(crd,result.item);
//                                            nextCallback(true);
//                                        });
//                                return;
//                            }
//                            nextCallback();
//                        })
                        .addDetailTableRowChangeCallback(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback) {
                            if ( (crd.item("ProdID").isChanged()&&!crd.item("ProdID").isEMPTY())
                                    || (crd.item("ProdName").isChanged()&&!crd.item("ProdName").isEMPTY()) ) {
                                var condition = {};
                                if (crd.item("ProdID").isChanged()&&!crd.item("ProdID").isEMPTY())
                                    condition["ProdID"]= crd.item("ProdID").getValue();
                                if (crd.item("ProdName").isChanged()&&!crd.item("ProdName").isEMPTY())
                                    condition["ProdName"]= encodeURIComponent(crd.item("ProdName").getValue());
                                Request.getJSONData({url:"/dirsProds/getProdDataByIDName", condition:condition},
                                        function(result){
                                            if (!result || !result.item ) {
                                                nextCallback();
                                                return;
                                            }
                                            thisInstance.setDetailTableProdData(crd,result.item);
                                            thisInstance.setDetailTableProdAttrs(crd,result.item);
                                            nextCallback(true);
                                        });
                                return;
                            }
                            nextCallback();
                        })
//                        .addDetailTableRowChangeCallback(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback){
//                            var supplierOrderNum= thisInstance.detailHeader.getContentDataItem("SUPPLIER_ORDER_NUM");
//
//
//                            if (!supplierOrderNum || supplierOrderNum.trim().length==0){
//                                if(crd.item("PRODUCT_GENDER_CODE").isChanged()&&!crd.item("PRODUCT_GENDER_CODE").isUNDEFNULL()){
//                                    var genderValueForGenderCode=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_GENDER_CODE",crd.item("PRODUCT_GENDER_CODE").getValue(),"PRODUCT_GENDER");
//                                    if(genderValueForGenderCode==undefined) genderValueForGenderCode=null;
//                                    crd.item("PRODUCT_GENDER").setValue(genderValueForGenderCode);
//                                } else if(crd.item("PRODUCT_GENDER").isChanged()&&!crd.item("PRODUCT_GENDER").isUNDEFNULL()){
//                                    var genderCodeValueForGender=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_GENDER",crd.item("PRODUCT_GENDER").getValue(),"PRODUCT_GENDER_CODE");
//                                    if(genderCodeValueForGender==undefined) genderCodeValueForGender=null;
//                                    crd.item("PRODUCT_GENDER_CODE").setValue(genderCodeValueForGender);
//                                }
//                                var genderValue,genderCode;
//                                if(crd.item("PRODUCT_CATEGORY_CODE").isChanged()&&!crd.item("PRODUCT_CATEGORY_CODE").isUNDEFNULL()){
//                                    var categoryValueForCategoryCode=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_CATEGORY_CODE",crd.item("PRODUCT_CATEGORY_CODE").getValue(),"PRODUCT_CATEGORY");
//                                    if(categoryValueForCategoryCode==undefined) categoryValueForCategoryCode=null;
//                                    crd.item("PRODUCT_CATEGORY").setValue(categoryValueForCategoryCode);
//                                    genderValue=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_CATEGORY_CODE",crd.item("PRODUCT_CATEGORY_CODE").getValue(),"PRODUCT_GENDER");
//                                    genderCode=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_CATEGORY_CODE",crd.item("PRODUCT_CATEGORY_CODE").getValue(),"PRODUCT_GENDER_CODE");
//
//                                } else if(crd.item("PRODUCT_CATEGORY").isChanged()&&!crd.item("PRODUCT_CATEGORY").isUNDEFNULL()){
//                                    var categoryCodeValueForCategory=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_CATEGORY",crd.item("PRODUCT_CATEGORY").getValue(),"PRODUCT_CATEGORY_CODE");
//                                    if(categoryCodeValueForCategory==undefined) categoryCodeValueForCategory=null;
//                                    crd.item("PRODUCT_CATEGORY_CODE").setValue(categoryCodeValueForCategory);
//                                    genderValue=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_CATEGORY",crd.item("PRODUCT_CATEGORY").getValue(),"PRODUCT_GENDER");
//                                    genderCode=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_CATEGORY",crd.item("PRODUCT_CATEGORY").getValue(),"PRODUCT_GENDER_CODE");
//                                }
//                                if(genderValue!==undefined&&crd.item("PRODUCT_GENDER").isEMPTY())
//                                    crd.item("PRODUCT_GENDER").setValue(genderValue);
//                                if(genderCode!==undefined&&crd.item("PRODUCT_GENDER_CODE").isEMPTY())
//                                    crd.item("PRODUCT_GENDER_CODE").setValue(genderCode);
//
//                                if(crd.item("PRODUCT_SUBCATEGORY_CODE").isChanged()&&!crd.item("PRODUCT_SUBCATEGORY_CODE").isUNDEFNULL()){
//                                    var subcategoryValueForSubcategoryCode=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_SUBCATEGORY_CODE",crd.item("PRODUCT_SUBCATEGORY_CODE").getValue(),"PRODUCT_SUBCATEGORY");
//                                    if(subcategoryValueForSubcategoryCode==undefined) subcategoryValueForSubcategoryCode=null;
//                                    crd.item("PRODUCT_SUBCATEGORY").setValue(subcategoryValueForSubcategoryCode);
//                                } else if(crd.item("PRODUCT_SUBCATEGORY").isChanged()&&!crd.item("PRODUCT_SUBCATEGORY").isUNDEFNULL()){
//                                    var subcategoryCodeValueForSubcategory=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_SUBCATEGORY",crd.item("PRODUCT_SUBCATEGORY").getValue(),"PRODUCT_SUBCATEGORY_CODE");
//                                    if(subcategoryCodeValueForSubcategory==undefined) subcategoryCodeValueForSubcategory=null;
//                                    crd.item("PRODUCT_SUBCATEGORY_CODE").setValue(subcategoryCodeValueForSubcategory);
//                                }
//                                if(crd.item("PRODUCT_COLLECTION").isEMPTY())
//                                    crd.item("PRODUCT_COLLECTION").setValue(thisInstance.detailHeader.getContentDataItem("PRODUCT_COLLECTION"));
//                                if(crd.item("PRODUCT_COLLECTION_CODE").isChanged()&&!crd.item("PRODUCT_COLLECTION_CODE").isUNDEFNULL()){
//                                    var collectionValueForCollectionCode=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_COLLECTION_CODE",crd.item("PRODUCT_COLLECTION_CODE").getValue(),"PRODUCT_COLLECTION");
//                                    if(collectionValueForCollectionCode==undefined) collectionValueForCollectionCode=null;
//                                    crd.item("PRODUCT_COLLECTION").setValue(collectionValueForCollectionCode);
//                                } else if(crd.item("PRODUCT_COLLECTION").isChanged()&&!crd.item("PRODUCT_COLLECTION").isUNDEFNULL()){
//                                    var collectionCodeValueForCollection=
//                                            detailTable.getAutocompleteColumnValueForItem("PRODUCT_COLLECTION",crd.item("PRODUCT_COLLECTION").getValue(),"PRODUCT_COLLECTION_CODE");
//                                    if(collectionCodeValueForCollection==undefined) collectionCodeValueForCollection=null;
//                                    crd.item("PRODUCT_COLLECTION_CODE").setValue(collectionCodeValueForCollection);
//                                }
////                                //docs_rec_pinvproductslisthst.setProdDataByArticleFromPInv(changedRow,newProdData);
//                            } else
//                            if (supplierOrderNum && supplierOrderNum.trim().length>0
//                                    && crd.item("PRODUCT_ARTICLE").isChanged() && !crd.item("PRODUCT_ARTICLE").isEMPTY()){              console.log("PINV detailTableRowChangeCallback1 prod article from order bata ");
////                                var condition={};
////                                condition["SUPPLIER_ORDER_NUM"]= supplierOrderNum;
////                                condition["PRODUCT_ARTICLE"]= crd.item("PRODUCT_ARTICLE").getValue();
////                                Request.getJSONData({url:"/wrh/order_bata/get_order_bata_details_by_article", condition:condition, consoleLog:true},
////                                        function(success,result){
////                                            if (success&&result.item) {                                                 //console.log("PINV detailTableRowChangeCallback2 getJSONData success ",result);
////                                                var prodDataFromOrderBata = result.item;
////                                                crd.item("PRODUCT_GENDER_CODE").setValue(prodDataFromOrderBata["PRODUCT_GENDER_CODE"]);
////                                                crd.item("PRODUCT_GENDER").setValue(prodDataFromOrderBata["PRODUCT_GENDER"]);
////                                                crd.item("PRODUCT_CATEGORY_CODE").setValue(prodDataFromOrderBata["PRODUCT_CATEGORY_CODE"]);
////                                                crd.item("PRODUCT_CATEGORY").setValue(prodDataFromOrderBata["PRODUCT_CATEGORY"]);
////                                                crd.item("PRODUCT_SUBCATEGORY_CODE").setValue(prodDataFromOrderBata["PRODUCT_SUBCATEGORY_CODE"]);
////                                                crd.item("PRODUCT_SUBCATEGORY").setValue(prodDataFromOrderBata["PRODUCT_SUBCATEGORY"]);
////                                                crd.item("PRICE").setValue(prodDataFromOrderBata["PRICE"]);
////                                                if (crd.item("QTY").isEMPTYZERO()) crd.item("QTY").setValue(prodDataFromOrderBata["QTY"]);
////                                                crd.item("PRODUCT_CODE").setValue(null);
////                                                crd.item("PRODUCT_NAME").setValue(null);
////                                                crd.item("PRODUCT_UM").setValue(null);
////                                                crd.item("PRODUCT_PBARCODE").setValue(null);
////                                                crd.item("BARCODE").setValue(null);
////                                            }
////                                            nextCallback();
////                                        });
////                                return;
//                            }
//                            nextCallback();
//                        })
//                        .addDetailTableRowChangeCallback(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback) {
//                            if( !crd.item("PRODUCT_CODE").isChanged()&&!crd.item("PRODUCT_NAME").isChanged()
//                                    &&  (crd.item("PRODUCT_ARTICLE").isChanged() || crd.item("PRODUCT_KIND").isChanged()
//                                        || crd.item("PRODUCT_COMPOSITION").isChanged() || crd.item("PRODUCT_SIZE").isChanged()
//                                        || crd.item("PRODUCT_COLLECTION").isChanged() || crd.item("PRODUCT_COLLECTION_CODE").isChanged()) ){
//                                var condition = {};
//                                if (!crd.item("PRODUCT_ARTICLE").isEMPTY())
//                                    condition["PRODUCT_ARTICLE"]= crd.item("PRODUCT_ARTICLE").getValue();
//                                if (!crd.item("PRODUCT_COLLECTION").isEMPTY())
//                                    condition["PRODUCT_COLLECTION"]= crd.item("PRODUCT_COLLECTION").getValue();
//                                if (!crd.item("PRODUCT_COLLECTION_CODE").isEMPTY())
//                                    condition["PRODUCT_COLLECTION_CODE"]= crd.item("PRODUCT_COLLECTION_CODE").getValue();
//                                if (!crd.item("PRODUCT_KIND").isEMPTY())
//                                    condition["PRODUCT_KIND"]= crd.item("PRODUCT_KIND").getValue();
//                                if (!crd.item("PRODUCT_COMPOSITION").isEMPTY())
//                                    condition["PRODUCT_COMPOSITION"]= encodeURIComponent(crd.item("PRODUCT_COMPOSITION").getValue());
//                                if (!crd.item("PRODUCT_SIZE").isEMPTY())
//                                    condition["PRODUCT_SIZE"]= crd.item("PRODUCT_SIZE").getValue();
//                                if (!crd.item("PRODUCT_UM").isEMPTY())
//                                    condition["PRODUCT_UM"]= crd.item("PRODUCT_UM").getValue();
//                                Request.getJSONData({url:"/dir/products/getProdNameByProdAttributes", condition:condition, resultItemName:"item"},
//                                        function(resData){
//                                            if (!resData) {
//                                                nextCallback();
//                                                return;
//                                            }
//                                            crd.item("PRODUCT_NAME").setValue(resData["PRODUCT_NAME"]);
//                                            crd.item("PRODUCT_PRINT_NAME").setValue(resData["PRODUCT_PRINT_NAME"]);
//                                            crd.item("PRODUCT_UM").setValue(resData["PRODUCT_UM"]);
////                                            crd.item("PRODUCT_PBARCODE").setValue("");
////                                            crd.item("BARCODE").setValue("");
////                                            crd.item("PRODUCT_CODE").setValue("");
//                                            nextCallback(true);
//                                        });
//                                return;
//                            }
//                            nextCallback();
//                        })
                        .addDetailTableRowChangeCallback(function(crd/*changedRowData*/, detailTable, thisInstance, nextCallback){          //console.log("INV detailTableRowChangeCallback1 ",crd.data());
                            var prevSrcPosID=detailTable.getPrevRowDataItemValue(crd.data(),"SrcPosID");
                            if(prevSrcPosID===undefined||prevSrcPosID===null||isNaN(prevSrcPosID/1)) prevSrcPosID=0;
                            if (crd.item("SrcPosID").isUNDEFNULL()) crd.item("SrcPosID").setValue(prevSrcPosID+1);
                            else if (crd.item("SrcPosID").getValue()===prevSrcPosID) crd.item("SrcPosID").setValue(prevSrcPosID+1);
//
                            if (crd.item("Qty").isUNDEFNULL()) crd.item("Qty").setValue(1);
                            if (crd.item("PriceCC_wt").isUNDEFNULL()) crd.item("PriceCC_wt").setValue(0);
                            if (crd.item("SumCC_wt").isUNDEFNULL()) crd.item("SumCC_wt").setValue(0);
                            if (crd.item("SumCC_wt").isChanged()&&!crd.item("SumCC_wt").isUNDEFNULL()){                     //console.log("detailTableRowChangeCallback SumCC_wt changed",crd,crd.item("Qty").isEMPTYZERO());
                                if (crd.item("Qty").isEMPTY()&&!crd.item("PriceCC_wt").isEMPTYZERO())
                                    crd.item("Qty").setValue( crd.item("SumCC_wt").getValue()/crd.item("PriceCC_wt").getValue() );
                                else if (crd.item("Qty").isEMPTYZERO()) crd.item("PriceCC_wt").setValue(0);
                                else crd.item("PriceCC_wt").setValue( crd.item("SumCC_wt").getValue()/crd.item("Qty").getValue() )
                            } else if (crd.item("PriceCC_wt").isChanged()||crd.item("Qty").isChanged()){                    //console.log("detailTableRowChangeCallback PRICE QTY changed",crd);
                                if (crd.item("Qty").isUNDEFNULLZERO()||crd.item("PriceCC_wt").isUNDEFNULLZERO()) crd.item("SumCC_wt").setValue(0);
                                else crd.item("SumCC_wt").setValue( crd.item("PriceCC_wt").getValue()*crd.item("Qty").getValue() )
                            } else if (!crd.item("PriceCC_wt").isEMPTY()) {
                                if (crd.item("Qty").isEMPTYZERO()) crd.item("PriceCC_wt").setValue(0);
                                else crd.item("PriceCC_wt").setValue( crd.item("SumCC_wt").getValue()/crd.item("Qty").getValue() )
                            }
                            if(crd.item("Extra").isEMPTYZERO()) crd.item("Extra").setValue(0);
                            if (crd.item("PriceCC_wt").isChanged() || crd.item("Extra").isChanged()) {                      //console.log("PINV detailTableRowChangeCallback1 PRICE or FACTOR isChanged");
                                if (!crd.item("PriceCC_wt").isEMPTY() && !crd.item("Extra").isEMPTY()) {
                                    crd.item("PriceCC").setValue( crd.item("PriceCC_wt").getValue()*(1+crd.item("Extra").getValue()/100) );
                                } else
                                    crd.item("PriceCC").setValue("");
                            } else if (crd.item("PriceCC").isChanged()) {                                                   //console.log("PINV detailTableRowChangeCallback1 SALE_PRICE isChanged");
                                if (!crd.item("Qty").isEMPTY() && !crd.item("PriceCC_wt").isEMPTYZERO()) {
                                    crd.item("Extra").setValue( (crd.item("PriceCC").getValue()/crd.item("PriceCC_wt").getValue()-1)*100 );
                                } else
                                    crd.item("Extra").setValue("");
                            }
//                            if (crd.item("SALE_PRICE").isChanged() && !crd.item("SALE_PRICE").isEMPTYZERO()){
//                                var posSelPrice = crd.item("SALE_PRICE").getValue();                                    console.log("PINV detailTableRowChangeCallback1 SALE_PRICE correct 0.49 ",posSelPrice);
//                                posSelPrice = Math.round(posSelPrice+0.49);
//                                crd.item("SALE_PRICE").setValue(posSelPrice);
//                                var price = crd.item("PRICE").getValue();
//                                if (price!==0)
//                                    crd.item("FACTOR").setValue( posSelPrice / posrate / price );
//                            }
                            nextCallback();
                        })
//                        .addToolPane({title:"экспорт"})
//                        .addToolPaneActionButton("таблица в эксель", {btnStyle: "width:200px;",detailTableActionName:"exportTableContentToExcel"})
                        .addToolPane({title:"Печать"})
                        .addToolPaneActionButton("Печать ценников", {btnStyle: "width:200px;",detailTableActionName:"printProdTags",
                            actionFunction:  function(actionFunctionParams){                                        console.log("printProdTags.onClick actionFunctionParams=",actionFunctionParams);
                                var printWindow= window.open("/print/printProductsTags");                           //console.log("printProdTags.onClick printWindow=",printWindow);
                                //window.open("/print?pinvid="+docs_rec_ContentController.getDataIDValue(), "", "location=1,status=1,scrollbars=1,width=650,height=600");
                                printWindow["prodTagsContentData"]= actionFunctionParams.detailTable.getContent();
                                printWindow["pageProdTagType"]= "productTag40x25";}
                            })
                        .addToolPaneActionButton("Печать цен", {btnStyle: "width:200px;", detailTableActionName:"printProdPricesTags",
                            actionFunction:function(actionFunctionParams){
                                var printWindow= window.open("/print/printProductsTags");
                                //window.open("/print?pinvid="+docs_rec_ContentController.getDataIDValue(), "", "location=1,status=1,scrollbars=1,width=650,height=600");
                                var detailTableContentData=actionFunctionParams.detailTable.getContent();
                                for(var row=0;row<detailTableContentData.length;row++) detailTableContentData[row]["QTY"]=1;
                                printWindow["prodTagsContentData"]= detailTableContentData;
                                printWindow["pageProdTagType"]= "tag40x25price";
                            }
                        })
                        .addToolPane({title:"Информация о товаре",
                            detailTableAction:function(toolPane, detailHeader,detailTable,thisInstance){
                                var detailTableSelectedRow= detailTable.getSelectedRow();
                                if(!detailTableSelectedRow){
                                    toolPane.set("content","");
                                    return;
                                }
                                var htCols = detailTable.getColumns(); var prodInfoHtml = "";

                                for(var c=0;c<htCols.length;c++){
                                    var colItem = htCols[c]; var colData = colItem["data"];
                                    var colValue = detailTableSelectedRow[colData];
                                    if(colData.indexOf('Prod')==0||colData=='UM'||colData.indexOf('Barcode')==0
                                            ||colData.indexOf('Article')==0||colData.indexOf('PCat')==0||colData.indexOf('PGr')==0
                                            ||colData.indexOf('Color')==0||colData.indexOf('Size')==0)
                                        prodInfoHtml = prodInfoHtml + "<tr><td>"+"<b>"+colItem["name"]+":</b> "+((!colValue)?'':colValue)+"</td></tr>";
                                }
                                toolPane.set("content","<table style=\"margin:0;padding:0;\">"+prodInfoHtml+"</table>");
                            }
                        })
                        .addToolXPane("Ценник товара", function(toolPane, detailHeader,detailTable,thisInstance){
//                            toolPane.set("content","");
                            var detailTableSelectedRow= detailTable.getSelectedRow();
                            if(detailTableSelectedRow) {
                                var prodTagContentData = {};
                                for(var rowItemName in detailTableSelectedRow) prodTagContentData[rowItemName]= detailTableSelectedRow[rowItemName];
                                toolPane.set("prodTagContentData", prodTagContentData);
                                toolPane.set("href","/print/productTag40x25");
                            }
                        })
                        .startUp();
    });
</script>
